
Artificial Intelligence Nanodegree
Convolutional Neural Networks
Project: Write an Algorithm for a Dog Identification App

In this notebook, some template code has already been provided for you, and you will need to implement additional functionality to successfully complete this project. You will not need to modify the included code beyond what is requested. Sections that begin with '(IMPLEMENTATION)' in the header indicate that the following block of code will require additional functionality which you must provide. Instructions will be provided for each section, and the specifics of the implementation are marked in the code block with a 'TODO' statement. Please be sure to read the instructions carefully!

    Note: Once you have completed all of the code implementations, you need to finalize your work by exporting the iPython Notebook as an HTML document. Before exporting the notebook to html, all of the code cells need to have been run so that reviewers can see the final implementation and output. You can then export the notebook by using the menu above and navigating to \n", "File -> Download as -> HTML (.html). Include the finished document along with this notebook as your submission.

In addition to implementing code, there will be questions that you must answer which relate to the project and your implementation. Each section where you will answer a question is preceded by a 'Question X' header. Carefully read each question and provide thorough answers in the following text boxes that begin with 'Answer:'. Your project submission will be evaluated based on your answers to each of the questions and the implementation you provide.

    Note: Code and Markdown cells can be executed using the Shift + Enter keyboard shortcut. Markdown cells can be edited by double-clicking the cell to enter edit mode.

The rubric contains optional "Stand Out Suggestions" for enhancing the project beyond the minimum requirements. If you decide to pursue the "Stand Out Suggestions", you should include the code in this IPython notebook.
Why We're Here

In this notebook, you will make the first steps towards developing an algorithm that could be used as part of a mobile or web app. At the end of this project, your code will accept any user-supplied image as input. If a dog is detected in the image, it will provide an estimate of the dog's breed. If a human is detected, it will provide an estimate of the dog breed that is most resembling. The image below displays potential sample output of your finished project (... but we expect that each student's algorithm will behave differently!).

Sample Dog Output

In this real-world setting, you will need to piece together a series of models to perform different tasks; for instance, the algorithm that detects humans in an image will be different from the CNN that infers dog breed. There are many points of possible failure, and no perfect algorithm exists. Your imperfect solution will nonetheless create a fun user experience!
The Road Ahead

We break the notebook into separate steps. Feel free to use the links below to navigate the notebook.

    Step 0: Import Datasets
    Step 1: Detect Humans
    Step 2: Detect Dogs
    Step 3: Create a CNN to Classify Dog Breeds (from Scratch)
    Step 4: Use a CNN to Classify Dog Breeds (using Transfer Learning)
    Step 5: Create a CNN to Classify Dog Breeds (using Transfer Learning)
    Step 6: Write your Algorithm
    Step 7: Test Your Algorithm

Step 0: Import Datasets
Import Dog Dataset

In the code cell below, we import a dataset of dog images. We populate a few variables through the use of the load_files function from the scikit-learn library:

    train_files, valid_files, test_files - numpy arrays containing file paths to images
    train_targets, valid_targets, test_targets - numpy arrays containing onehot-encoded classification labels
    dog_names - list of string-valued dog breed names for translating labels

from sklearn.datasets import load_files       
from keras.utils import np_utils
import numpy as np
from glob import glob

# define function to load train, test, and validation datasets
def load_dataset(path):
    data = load_files(path)
    dog_files = np.array(data['filenames'])
    dog_targets = np_utils.to_categorical(np.array(data['target']), 133)
    return dog_files, dog_targets

# load train, test, and validation datasets
train_files, train_targets = load_dataset('dogImages/train')
valid_files, valid_targets = load_dataset('dogImages/valid')
test_files, test_targets = load_dataset('dogImages/test')

# load list of dog names
dog_names = [item[20:-1] for item in sorted(glob("dogImages/train/*/"))]

# print statistics about the dataset
print('There are %d total dog categories.' % len(dog_names))
print('There are %s total dog images.\n' % len(np.hstack([train_files, valid_files, test_files])))
print('There are %d training dog images.' % len(train_files))
print('There are %d validation dog images.' % len(valid_files))
print('There are %d test dog images.'% len(test_files))

Using TensorFlow backend.

There are 133 total dog categories.
There are 8351 total dog images.

There are 6680 training dog images.
There are 835 validation dog images.
There are 836 test dog images.

Import Human Dataset

In the code cell below, we import a dataset of human images, where the file paths are stored in the numpy array human_files.

import random
random.seed(8675309)

# load filenames in shuffled human dataset
human_files = np.array(glob("lfw/*/*"))
random.shuffle(human_files)

# print statistics about the dataset
print('There are %d total human images.' % len(human_files))

There are 13233 total human images.

Step 1: Detect Humans

We use OpenCV's implementation of Haar feature-based cascade classifiers to detect human faces in images. OpenCV provides many pre-trained face detectors, stored as XML files on github. We have downloaded one of these detectors and stored it in the haarcascades directory.

In the next code cell, we demonstrate how to use this detector to find human faces in a sample image.

import cv2                
import matplotlib.pyplot as plt                        
%matplotlib inline                               

# extract pre-trained face detector
face_cascade = cv2.CascadeClassifier('haarcascades/haarcascade_frontalface_alt.xml')

# load color (BGR) image
img = cv2.imread(human_files[3])
# convert BGR image to grayscale
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# find faces in image
faces = face_cascade.detectMultiScale(gray)

# print number of faces detected in the image
print('Number of faces detected:', len(faces))

# get bounding box for each detected face
for (x,y,w,h) in faces:
    # add bounding box to color image
    cv2.rectangle(img,(x,y),(x+w,y+h),(255,0,0),2)
    
# convert BGR image to RGB for plotting
cv_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

# display the image, along with bounding box
plt.imshow(cv_rgb)
plt.show()

Number of faces detected: 1

Before using any of the face detectors, it is standard procedure to convert the images to grayscale. The detectMultiScale function executes the classifier stored in face_cascade and takes the grayscale image as a parameter.

In the above code, faces is a numpy array of detected faces, where each row corresponds to a detected face. Each detected face is a 1D array with four entries that specifies the bounding box of the detected face. The first two entries in the array (extracted in the above code as x and y) specify the horizontal and vertical positions of the top left corner of the bounding box. The last two entries in the array (extracted here as w and h) specify the width and height of the box.
Write a Human Face Detector

We can use this procedure to write a function that returns True if a human face is detected in an image and False otherwise. This function, aptly named face_detector, takes a string-valued file path to an image as input and appears in the code block below.

# returns "True" if face is detected in image stored at img_path
def face_detector(img_path):
    img = cv2.imread(img_path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    faces = face_cascade.detectMultiScale(gray)
    return len(faces) > 0

(IMPLEMENTATION) Assess the Human Face Detector

Question 1: Use the code cell below to test the performance of the face_detector function.

    What percentage of the first 100 images in human_files have a detected human face?
    What percentage of the first 100 images in dog_files have a detected human face?

Ideally, we would like 100% of human images with a detected face and 0% of dog images with a detected face. You will see that our algorithm falls short of this goal, but still gives acceptable performance. We extract the file paths for the first 100 images from each of the datasets and store them in the numpy arrays human_files_short and dog_files_short.

Answer: 98% of the first 100 images in human_files have a detected human face and 11% of the first 100 images in dog_files have a detected human face.

human_files_short = human_files[:100]
dog_files_short = train_files[:100]
# Do NOT modify the code above this line.

## TODO: Test the performance of the face_detector algorithm 
## on the images in human_files_short and dog_files_short.
count_human_faces = 0
for each_image in human_files_short: # Iterating through each human image to see if human is detected
    if face_detector(each_image):
        count_human_faces += 1
print('There are %d total human images correctly detected.' % count_human_faces)
### getting number of dog images detected by face detector
count_dog_faces = 0
for each_image in dog_files_short:  # Iterating though each dog image to see if human is detected
    if face_detector(each_image):
        count_dog_faces += 1
print('There are %d total dog images detected with human face.' % count_dog_faces)

There are 98 total human images correctly detected.
There are 11 total dog images detected with human face.

Question 2: This algorithmic choice necessitates that we communicate to the user that we accept human images only when they provide a clear view of a face (otherwise, we risk having unneccessarily frustrated users!). In your opinion, is this a reasonable expectation to pose on the user? If not, can you think of a way to detect humans in images that does not necessitate an image with a clearly presented face?

Answer:It doesn't seem to be reasonable. Instead of trying to detect the face, face with hair can be tried to detect. There will still be problem if someone doesn't have hair, but it will increase the accuracy significantly.

We suggest the face detector from OpenCV as a potential way to detect human images in your algorithm, but you are free to explore other approaches, especially approaches that make use of deep learning :). Please use the code cell below to design and test your own face detection algorithm. If you decide to pursue this optional task, report performance on each of the datasets.

## (Optional) TODO: Report the performance of another  
## face detection algorithm on the LFW dataset
### Feel free to use as many code cells as needed.

Step 2: Detect Dogs

In this section, we use a pre-trained ResNet-50 model to detect dogs in images. Our first line of code downloads the ResNet-50 model, along with weights that have been trained on ImageNet, a very large, very popular dataset used for image classification and other vision tasks. ImageNet contains over 10 million URLs, each linking to an image containing an object from one of 1000 categories. Given an image, this pre-trained ResNet-50 model returns a prediction (derived from the available categories in ImageNet) for the object that is contained in the image.

from keras.applications.resnet50 import ResNet50

# define ResNet50 model
ResNet50_model = ResNet50(weights='imagenet')

Pre-process the Data

When using TensorFlow as backend, Keras CNNs require a 4D array (which we'll also refer to as a 4D tensor) as input, with shape
(nb_samples,rows,columns,channels),

where nb_samples corresponds to the total number of images (or samples), and rows, columns, and channels correspond to the number of rows, columns, and channels for each image, respectively.

The path_to_tensor function below takes a string-valued file path to a color image as input and returns a 4D tensor suitable for supplying to a Keras CNN. The function first loads the image and resizes it to a square image that is 224×224

pixels. Next, the image is converted to an array, which is then resized to a 4D tensor. In this case, since we are working with color images, each image has three channels. Likewise, since we are processing a single image (or sample), the returned tensor will always have shape
(1,224,224,3).

The paths_to_tensor function takes a numpy array of string-valued image paths as input and returns a 4D tensor with shape
(nb_samples,224,224,3).

Here, nb_samples is the number of samples, or number of images, in the supplied array of image paths. It is best to think of nb_samples as the number of 3D tensors (where each 3D tensor corresponds to a different image) in your dataset!

from keras.preprocessing import image                  
from tqdm import tqdm

def path_to_tensor(img_path):
    # loads RGB image as PIL.Image.Image type
    img = image.load_img(img_path, target_size=(224, 224))
    # convert PIL.Image.Image type to 3D tensor with shape (224, 224, 3)
    x = image.img_to_array(img)
    # convert 3D tensor to 4D tensor with shape (1, 224, 224, 3) and return 4D tensor
    return np.expand_dims(x, axis=0)

def paths_to_tensor(img_paths):
    list_of_tensors = [path_to_tensor(img_path) for img_path in tqdm(img_paths)]
    return np.vstack(list_of_tensors)

Making Predictions with ResNet-50

Getting the 4D tensor ready for ResNet-50, and for any other pre-trained model in Keras, requires some additional processing. First, the RGB image is converted to BGR by reordering the channels. All pre-trained models have the additional normalization step that the mean pixel (expressed in RGB as [103.939,116.779,123.68]

and calculated from all pixels in all images in ImageNet) must be subtracted from every pixel in each image. This is implemented in the imported function preprocess_input. If you're curious, you can check the code for preprocess_input here.

Now that we have a way to format our image for supplying to ResNet-50, we are now ready to use the model to extract the predictions. This is accomplished with the predict method, which returns an array whose i
-th entry is the model's predicted probability that the image belongs to the i

-th ImageNet category. This is implemented in the ResNet50_predict_labels function below.

By taking the argmax of the predicted probability vector, we obtain an integer corresponding to the model's predicted object class, which we can identify with an object category through the use of this dictionary.

from keras.applications.resnet50 import preprocess_input, decode_predictions

def ResNet50_predict_labels(img_path):
    # returns prediction vector for image located at img_path
    img = preprocess_input(path_to_tensor(img_path))
    return np.argmax(ResNet50_model.predict(img))

Write a Dog Detector

While looking at the dictionary, you will notice that the categories corresponding to dogs appear in an uninterrupted sequence and correspond to dictionary keys 151-268, inclusive, to include all categories from 'Chihuahua' to 'Mexican hairless'. Thus, in order to check to see if an image is predicted to contain a dog by the pre-trained ResNet-50 model, we need only check if the ResNet50_predict_labels function above returns a value between 151 and 268 (inclusive).

We use these ideas to complete the dog_detector function below, which returns True if a dog is detected in an image (and False if not).

### returns "True" if a dog is detected in the image stored at img_path
def dog_detector(img_path):
    prediction = ResNet50_predict_labels(img_path)
    return ((prediction <= 268) & (prediction >= 151)) 

(IMPLEMENTATION) Assess the Dog Detector

Question 3: Use the code cell below to test the performance of your dog_detector function.

    What percentage of the images in human_files_short have a detected dog?
    What percentage of the images in dog_files_short have a detected dog?

Answer: 1% of the first 100 images in human_files have an incorrectly detected dog face and 100% of the first 100 images in dog_files have correctly detected dog.

### TODO: Test the performance of the dog_detector function
### on the images in human_files_short and dog_files_short.
count_human_faces = 0
for each_image in human_files_short: # Iterating through each human image to see if dog is detected
    if dog_detector(each_image):
        count_human_faces += 1
print('There are %d total human images incorrectly detected as dogs.' % count_human_faces)
### getting number of dog images detected by face detector
count_dog_faces = 0
for each_image in dog_files_short:   # Iterating through each dog image to see if dog is detected
    if dog_detector(each_image):
        count_dog_faces += 1
print('There are %d total dog images correctly detected.' % count_dog_faces)

There are 1 total human images incorrectly detected as dogs.
There are 100 total dog images correctly detected.

Step 3: Create a CNN to Classify Dog Breeds (from Scratch)

Now that we have functions for detecting humans and dogs in images, we need a way to predict breed from images. In this step, you will create a CNN that classifies dog breeds. You must create your CNN from scratch (so, you can't use transfer learning yet!), and you must attain a test accuracy of at least 1%. In Step 5 of this notebook, you will have the opportunity to use transfer learning to create a CNN that attains greatly improved accuracy.

Be careful with adding too many trainable layers! More parameters means longer training, which means you are more likely to need a GPU to accelerate the training process. Thankfully, Keras provides a handy estimate of the time that each epoch is likely to take; you can extrapolate this estimate to figure out how long it will take for your algorithm to train.

We mention that the task of assigning breed to dogs from images is considered exceptionally challenging. To see why, consider that even a human would have great difficulty in distinguishing between a Brittany and a Welsh Springer Spaniel.
Brittany 	Welsh Springer Spaniel
	

It is not difficult to find other dog breed pairs with minimal inter-class variation (for instance, Curly-Coated Retrievers and American Water Spaniels).
Curly-Coated Retriever 	American Water Spaniel
	

Likewise, recall that labradors come in yellow, chocolate, and black. Your vision-based algorithm will have to conquer this high intra-class variation to determine how to classify all of these different shades as the same breed.
Yellow Labrador 	Chocolate Labrador 	Black Labrador
		

We also mention that random chance presents an exceptionally low bar: setting aside the fact that the classes are slightly imabalanced, a random guess will provide a correct answer roughly 1 in 133 times, which corresponds to an accuracy of less than 1%.

Remember that the practice is far ahead of the theory in deep learning. Experiment with many different architectures, and trust your intuition. And, of course, have fun!
Pre-process the Data

We rescale the images by dividing every pixel in every image by 255.

from PIL import ImageFile                            
ImageFile.LOAD_TRUNCATED_IMAGES = True                 

# pre-process the data for Keras
train_tensors = paths_to_tensor(train_files).astype('float32')/255
valid_tensors = paths_to_tensor(valid_files).astype('float32')/255
test_tensors = paths_to_tensor(test_files).astype('float32')/255

100%|██████████| 6680/6680 [02:19<00:00, 47.91it/s]
100%|██████████| 835/835 [00:16<00:00, 51.81it/s]
100%|██████████| 836/836 [00:15<00:00, 52.80it/s]

(IMPLEMENTATION) Model Architecture

Create a CNN to classify dog breed. At the end of your code cell block, summarize the layers of your model by executing the line:

    model.summary()

We have imported some Python modules to get you started, but feel free to import as many modules as you need. If you end up getting stuck, here's a hint that specifies a model that trains relatively fast on CPU and attains >1% test accuracy in 5 epochs:

Sample CNN

Question 4: Outline the steps you took to get to your final CNN architecture and your reasoning at each step. If you chose to use the hinted architecture above, describe why you think that CNN architecture should work well for the image classification task.

Answer: Started with the given architecture above. Then added one more conv layer and maxpooling layer to improve the model performance.

There are total 4 convolution layers. The number of filters were increased gradually from the first conv layer to last one. The easiest way to classify breeds is distinguishing the face between breeds. So higher number of filters would help detecting different edges and their distances from each other. Although higher the number of filters, it should work better, but would lead to overfitting and blow up in number of feature maps. That's why filters were increased gradually instead of using large number of filters at each step. Number of strides were 1 always so that nothing is missed. Kernel size was chosen as 2, larger number here would give smaller number of feature maps but would likely to miss some patterns. Relu activation was used to take care of non-linearity.

Maxpooling layers were reducing the feature maps and saving training time as it was taking only the maximum of some data. Again, there is tradeoff between training time and model complexity.

Global average pooling reduces the complexity before dense layer so that there is no overfitting. Finally dense layer with 133 nodes are needed as there are 133 breed categories. Dense layer here combines everything and makes sure impact of any previous node is not missed.

from keras.layers import Conv2D, MaxPooling2D, GlobalAveragePooling2D
from keras.layers import Dropout, Flatten, Dense
from keras.models import Sequential

model = Sequential()

### TODO: Define your architecture.
model.add(Conv2D(filters=16, kernel_size=2, strides=1, padding='valid', activation='relu', input_shape=(224, 224, 3)))
model.add(MaxPooling2D(pool_size=2, strides=2, input_shape=(111, 111, 16)))
model.add(Conv2D(filters=32, kernel_size=2, strides=1, padding='valid', activation='relu', input_shape=(111, 111, 1)))
model.add(MaxPooling2D(pool_size=2, strides=2, input_shape=(111, 111, 32)))
model.add(Conv2D(filters=64, kernel_size=2, strides=1, padding='valid', activation='relu', input_shape=(111, 111, 1)))
model.add(MaxPooling2D(pool_size=2, strides=2, input_shape=(111, 111, 64)))

model.add(Conv2D(filters=64, kernel_size=2, strides=1, padding='valid', activation='relu', input_shape=(111, 111, 1)))
model.add(MaxPooling2D(pool_size=2, strides=2, input_shape=(111, 111, 128)))

model.add(GlobalAveragePooling2D(data_format=None))
model.add(Dense(133, activation='relu'))

model.summary()

_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_4 (Conv2D)            (None, 223, 223, 16)      208       
_________________________________________________________________
max_pooling2d_5 (MaxPooling2 (None, 111, 111, 16)      0         
_________________________________________________________________
conv2d_5 (Conv2D)            (None, 110, 110, 32)      2080      
_________________________________________________________________
max_pooling2d_6 (MaxPooling2 (None, 55, 55, 32)        0         
_________________________________________________________________
conv2d_6 (Conv2D)            (None, 54, 54, 64)        8256      
_________________________________________________________________
max_pooling2d_7 (MaxPooling2 (None, 27, 27, 64)        0         
_________________________________________________________________
conv2d_7 (Conv2D)            (None, 26, 26, 64)        16448     
_________________________________________________________________
max_pooling2d_8 (MaxPooling2 (None, 13, 13, 64)        0         
_________________________________________________________________
global_average_pooling2d_4 ( (None, 64)                0         
_________________________________________________________________
dense_5 (Dense)              (None, 133)               8645      
=================================================================
Total params: 35,637.0
Trainable params: 35,637.0
Non-trainable params: 0.0
_________________________________________________________________

Compile the Model

model.compile(optimizer='rmsprop', loss='categorical_crossentropy', metrics=['accuracy'])

(IMPLEMENTATION) Train the Model

Train your model in the code cell below. Use model checkpointing to save the model that attains the best validation loss.

You are welcome to augment the training data, but this is not a requirement.

from keras.callbacks import ModelCheckpoint  

### TODO: specify the number of epochs that you would like to use to train the model.

epochs = 6

### Do NOT modify the code below this line.

checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.from_scratch.hdf5', 
                               verbose=1, save_best_only=True)

model.fit(train_tensors, train_targets, 
          validation_data=(valid_tensors, valid_targets),
          epochs=epochs, batch_size=20, callbacks=[checkpointer], verbose=1)

Train on 6680 samples, validate on 835 samples
Epoch 1/6
6660/6680 [============================>.] - ETA: 0s - loss: 11.6331 - acc: 0.0072      Epoch 00000: val_loss improved from inf to 12.35440, saving model to saved_models/weights.best.from_scratch.hdf5
6680/6680 [==============================] - 330s - loss: 11.6352 - acc: 0.0073 - val_loss: 12.3544 - val_acc: 0.0096
Epoch 2/6
6660/6680 [============================>.] - ETA: 0s - loss: 12.4078 - acc: 0.0095      Epoch 00001: val_loss did not improve
6680/6680 [==============================] - 301s - loss: 12.4054 - acc: 0.0099 - val_loss: 12.4458 - val_acc: 0.0072
Epoch 3/6
6660/6680 [============================>.] - ETA: 0s - loss: 12.6898 - acc: 0.0108      Epoch 00002: val_loss did not improve
6680/6680 [==============================] - 286s - loss: 12.6926 - acc: 0.0108 - val_loss: 13.2850 - val_acc: 0.0096
Epoch 4/6
6660/6680 [============================>.] - ETA: 0s - loss: 13.3161 - acc: 0.0098      Epoch 00003: val_loss did not improve
6680/6680 [==============================] - 278s - loss: 13.3095 - acc: 0.0097 - val_loss: 12.7145 - val_acc: 0.0060
Epoch 5/6
6660/6680 [============================>.] - ETA: 6s - loss: 11.9078 - acc: 0.0089      Epoch 00004: val_loss improved from 12.35440 to 11.80410, saving model to saved_models/weights.best.from_scratch.hdf5
6680/6680 [==============================] - 2308s - loss: 11.9000 - acc: 0.0090 - val_loss: 11.8041 - val_acc: 0.0108
Epoch 6/6
6660/6680 [============================>.] - ETA: 0s - loss: 12.1858 - acc: 0.0108  Epoch 00005: val_loss did not improve
6680/6680 [==============================] - 278s - loss: 12.1936 - acc: 0.0109 - val_loss: 13.2553 - val_acc: 0.0084

<keras.callbacks.History at 0x329318c50>

Load the Model with the Best Validation Loss

model.load_weights('saved_models/weights.best.from_scratch.hdf5')

Test the Model

Try out your model on the test dataset of dog images. Ensure that your test accuracy is greater than 1%.

# get index of predicted dog breed for each image in test set
dog_breed_predictions = [np.argmax(model.predict(np.expand_dims(tensor, axis=0))) for tensor in test_tensors]

# report test accuracy
test_accuracy = 100*np.sum(np.array(dog_breed_predictions)==np.argmax(test_targets, axis=1))/len(dog_breed_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)

Test accuracy: 1.1962%

Step 4: Use a CNN to Classify Dog Breeds

To reduce training time without sacrificing accuracy, we show you how to train a CNN using transfer learning. In the following step, you will get a chance to use transfer learning to train your own CNN.
Obtain Bottleneck Features

bottleneck_features = np.load('bottleneck_features/DogVGG16Data.npz')
train_VGG16 = bottleneck_features['train']
valid_VGG16 = bottleneck_features['valid']
test_VGG16 = bottleneck_features['test']

Model Architecture

The model uses the the pre-trained VGG-16 model as a fixed feature extractor, where the last convolutional output of VGG-16 is fed as input to our model. We only add a global average pooling layer and a fully connected layer, where the latter contains one node for each dog category and is equipped with a softmax.

VGG16_model = Sequential()
VGG16_model.add(GlobalAveragePooling2D(input_shape=train_VGG16.shape[1:]))
VGG16_model.add(Dense(133, activation='softmax'))

VGG16_model.summary()

_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
global_average_pooling2d_2 ( (None, 512)               0         
_________________________________________________________________
dense_2 (Dense)              (None, 133)               68229     
=================================================================
Total params: 68,229.0
Trainable params: 68,229.0
Non-trainable params: 0.0
_________________________________________________________________

Compile the Model

VGG16_model.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])

Train the Model

checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.VGG16.hdf5', 
                               verbose=1, save_best_only=True)

VGG16_model.fit(train_VGG16, train_targets, 
          validation_data=(valid_VGG16, valid_targets),
          epochs=20, batch_size=20, callbacks=[checkpointer], verbose=1)

Train on 6680 samples, validate on 835 samples
Epoch 1/20
6520/6680 [============================>.] - ETA: 0s - loss: 11.8251 - acc: 0.1256       - ETA: 0s - loss: 12.1839 - acc: 0.1056Epoch 00000: val_loss improved from inf to 10.27214, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 4s - loss: 11.7925 - acc: 0.1280 - val_loss: 10.2721 - val_acc: 0.2299
Epoch 2/20
6660/6680 [============================>.] - ETA: 0s - loss: 9.5835 - acc: 0.3035 Epoch 00001: val_loss improved from 10.27214 to 9.64307, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 9.5780 - acc: 0.3039 - val_loss: 9.6431 - val_acc: 0.2994
Epoch 3/20
6540/6680 [============================>.] - ETA: 0s - loss: 9.0394 - acc: 0.3668Epoch 00002: val_loss improved from 9.64307 to 9.43232, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 9.0367 - acc: 0.3669 - val_loss: 9.4323 - val_acc: 0.3162
Epoch 4/20
6640/6680 [============================>.] - ETA: 0s - loss: 8.6910 - acc: 0.4038Epoch 00003: val_loss improved from 9.43232 to 9.18312, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 8.6849 - acc: 0.4045 - val_loss: 9.1831 - val_acc: 0.3341
Epoch 5/20
6640/6680 [============================>.] - ETA: 0s - loss: 8.5081 - acc: 0.4286Epoch 00004: val_loss improved from 9.18312 to 9.12177, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 2s - loss: 8.5232 - acc: 0.4277 - val_loss: 9.1218 - val_acc: 0.3509
Epoch 6/20
6600/6680 [============================>.] - ETA: 0s - loss: 8.3649 - acc: 0.4456Epoch 00005: val_loss improved from 9.12177 to 8.90692, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 2s - loss: 8.3532 - acc: 0.4460 - val_loss: 8.9069 - val_acc: 0.3749
Epoch 7/20
6540/6680 [============================>.] - ETA: 0s - loss: 8.2420 - acc: 0.4628Epoch 00006: val_loss improved from 8.90692 to 8.83055, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 8.2354 - acc: 0.4635 - val_loss: 8.8306 - val_acc: 0.3665
Epoch 8/20
6560/6680 [============================>.] - ETA: 0s - loss: 8.1173 - acc: 0.4730Epoch 00007: val_loss improved from 8.83055 to 8.75449, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 8.1287 - acc: 0.4726 - val_loss: 8.7545 - val_acc: 0.3760
Epoch 9/20
6620/6680 [============================>.] - ETA: 0s - loss: 8.0854 - acc: 0.4846Epoch 00008: val_loss improved from 8.75449 to 8.70020, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 8.0781 - acc: 0.4852 - val_loss: 8.7002 - val_acc: 0.3808
Epoch 10/20
6660/6680 [============================>.] - ETA: 0s - loss: 8.0458 - acc: 0.4845Epoch 00009: val_loss improved from 8.70020 to 8.61364, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 8.0435 - acc: 0.4847 - val_loss: 8.6136 - val_acc: 0.3892
Epoch 11/20
6620/6680 [============================>.] - ETA: 0s - loss: 7.9169 - acc: 0.4992Epoch 00010: val_loss improved from 8.61364 to 8.53407, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.9141 - acc: 0.4993 - val_loss: 8.5341 - val_acc: 0.3940
Epoch 12/20
6500/6680 [============================>.] - ETA: 0s - loss: 7.9147 - acc: 0.5009 Epoch 00011: val_loss improved from 8.53407 to 8.46816, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.8809 - acc: 0.5031 - val_loss: 8.4682 - val_acc: 0.4060
Epoch 13/20
6480/6680 [============================>.] - ETA: 0s - loss: 7.8265 - acc: 0.5043Epoch 00012: val_loss improved from 8.46816 to 8.45929, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.8254 - acc: 0.5042 - val_loss: 8.4593 - val_acc: 0.4024
Epoch 14/20
6480/6680 [============================>.] - ETA: 0s - loss: 7.5712 - acc: 0.5079Epoch 00013: val_loss improved from 8.45929 to 8.16102, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.5560 - acc: 0.5087 - val_loss: 8.1610 - val_acc: 0.4120
Epoch 15/20
6640/6680 [============================>.] - ETA: 0s - loss: 7.3184 - acc: 0.5286Epoch 00014: val_loss improved from 8.16102 to 8.07663, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.3253 - acc: 0.5283 - val_loss: 8.0766 - val_acc: 0.4299
Epoch 16/20
6600/6680 [============================>.] - ETA: 0s - loss: 7.2465 - acc: 0.5368Epoch 00015: val_loss improved from 8.07663 to 8.04767, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.2300 - acc: 0.5379 - val_loss: 8.0477 - val_acc: 0.4275
Epoch 17/20
6520/6680 [============================>.] - ETA: 0s - loss: 7.1584 - acc: 0.5459Epoch 00016: val_loss improved from 8.04767 to 8.01801, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.1773 - acc: 0.5445 - val_loss: 8.0180 - val_acc: 0.4275
Epoch 18/20
6520/6680 [============================>.] - ETA: 0s - loss: 7.1213 - acc: 0.5489Epoch 00017: val_loss improved from 8.01801 to 7.85441, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.1138 - acc: 0.5493 - val_loss: 7.8544 - val_acc: 0.4407
Epoch 19/20
6620/6680 [============================>.] - ETA: 0s - loss: 7.0418 - acc: 0.5550Epoch 00018: val_loss improved from 7.85441 to 7.80483, saving model to saved_models/weights.best.VGG16.hdf5
6680/6680 [==============================] - 1s - loss: 7.0389 - acc: 0.5552 - val_loss: 7.8048 - val_acc: 0.4455
Epoch 20/20
6640/6680 [============================>.] - ETA: 0s - loss: 7.0228 - acc: 0.5605Epoch 00019: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 7.0170 - acc: 0.5609 - val_loss: 7.8446 - val_acc: 0.4407

<keras.callbacks.History at 0x1294cf080>

Load the Model with the Best Validation Loss

VGG16_model.load_weights('saved_models/weights.best.VGG16.hdf5')

Test the Model

Now, we can use the CNN to test how well it identifies breed within our test dataset of dog images. We print the test accuracy below.

# get index of predicted dog breed for each image in test set

VGG16_predictions = [np.argmax(VGG16_model.predict(np.expand_dims(feature, axis=0))) for feature in test_VGG16]

# report test accuracy
test_accuracy = 100*np.sum(np.array(VGG16_predictions)==np.argmax(test_targets, axis=1))/len(VGG16_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)

Test accuracy: 45.5742%

Predict Dog Breed with the Model

from extract_bottleneck_features import *

def VGG16_predict_breed(img_path):
    # extract bottleneck features
    bottleneck_feature = extract_VGG16(path_to_tensor(img_path))
    # obtain predicted vector
    predicted_vector = VGG16_model.predict(bottleneck_feature)
    # return dog breed that is predicted by the model
    return dog_names[np.argmax(predicted_vector)]

Step 5: Create a CNN to Classify Dog Breeds (using Transfer Learning)

You will now use transfer learning to create a CNN that can identify dog breed from images. Your CNN must attain at least 60% accuracy on the test set.

In Step 4, we used transfer learning to create a CNN using VGG-16 bottleneck features. In this section, you must use the bottleneck features from a different pre-trained model. To make things easier for you, we have pre-computed the features for all of the networks that are currently available in Keras:

    VGG-19 bottleneck features
    ResNet-50 bottleneck features
    Inception bottleneck features
    Xception bottleneck features

The files are encoded as such:

Dog{network}Data.npz

where {network}, in the above filename, can be one of VGG19, Resnet50, InceptionV3, or Xception. Pick one of the above architectures, download the corresponding bottleneck features, and store the downloaded file in the bottleneck_features/ folder in the repository.
(IMPLEMENTATION) Obtain Bottleneck Features

In the code block below, extract the bottleneck features corresponding to the train, test, and validation sets by running the following:

bottleneck_features = np.load('bottleneck_features/Dog{network}Data.npz')
train_{network} = bottleneck_features['train']
valid_{network} = bottleneck_features['valid']
test_{network} = bottleneck_features['test']

### TODO: Obtain bottleneck features from another pre-trained CNN.
bottleneck_features = np.load('bottleneck_features/DogVGG19Data.npz') # Loading the data
train_VGG19 = bottleneck_features['train'] # getting the train data
valid_VGG19 = bottleneck_features['valid'] # getting the validation data
test_VGG19 = bottleneck_features['test']   # getting the test data

(IMPLEMENTATION) Model Architecture

Create a CNN to classify dog breed. At the end of your code cell block, summarize the layers of your model by executing the line:

    <your model's name>.summary()

Question 5: Outline the steps you took to get to your final CNN architecture and your reasoning at each step. Describe why you think the architecture is suitable for the current problem.

Answer: Global average pooling, two dense layers, one with relu activation and other with softmax activation.

Global average pooling reduces overfitting by averaging the previous outputs and number of feature maps are also decreased. Dense layer with relu activation takes care of non-linearity and combines all previous nodes. Dense layer with softmax, converts the previous layer outputs to 133 output classes and makes sure each of these outputs are between 0 to 1 and their summation is 1.

This architecture used transfer learning. Already trained model had correct weights of nodes to detect things like edges, shapes etc. Different combinations of these things resemble different images. So to combine the pre-tarind model outputs, two dense layers(fully connected) were used. After combinations, they were able to detect the differences between different dog breeds. The previous model was not as good as this one, because it needs lot of iterations and training time to get the better model, those were avoided here by using pre-trained model from transfer learning. So with this one, the good parameters for model are already known for first few steps.

### TODO: Define your architecture.
from keras.layers import GlobalAveragePooling1D, GlobalMaxPooling2D
VGG19_model = Sequential()

VGG19_model.add(GlobalAveragePooling2D(input_shape=train_VGG19.shape[1:])) # Added global avg pooling layer

VGG19_model.add(Dense(133, activation='relu'))                             # Added dense layer with relu activation

VGG19_model.add(Dense(133, activation='softmax'))                          # Added dense layer with softmax activation

VGG19_model.summary()

_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
global_average_pooling2d_3 ( (None, 512)               0         
_________________________________________________________________
dense_3 (Dense)              (None, 133)               68229     
_________________________________________________________________
dense_4 (Dense)              (None, 133)               17822     
=================================================================
Total params: 86,051.0
Trainable params: 86,051.0
Non-trainable params: 0.0
_________________________________________________________________

(IMPLEMENTATION) Compile the Model

### TODO: Compile the model.
VGG19_model.compile(loss='categorical_crossentropy', optimizer='rmsprop', metrics=['accuracy'])

(IMPLEMENTATION) Train the Model

Train your model in the code cell below. Use model checkpointing to save the model that attains the best validation loss.

You are welcome to augment the training data, but this is not a requirement.

### TODO: Train the model.
checkpointer = ModelCheckpoint(filepath='saved_models/weights.best.VGG19.hdf5', 
                               verbose=1, save_best_only=True)

VGG19_model.fit(train_VGG19, train_targets, 
          validation_data=(valid_VGG19, valid_targets),
          epochs=35, batch_size=20, callbacks=[checkpointer], verbose=1)

Train on 6680 samples, validate on 835 samples
Epoch 1/35
6580/6680 [============================>.] - ETA: 0s - loss: 3.3990 - acc: 0.3062       Epoch 00000: val_loss improved from inf to 1.60944, saving model to saved_models/weights.best.VGG19.hdf5
6680/6680 [==============================] - 3s - loss: 3.3715 - acc: 0.3102 - val_loss: 1.6094 - val_acc: 0.5796
Epoch 2/35
6620/6680 [============================>.] - ETA: 0s - loss: 1.1096 - acc: 0.6884Epoch 00001: val_loss improved from 1.60944 to 1.39880, saving model to saved_models/weights.best.VGG19.hdf5
6680/6680 [==============================] - 1s - loss: 1.1076 - acc: 0.6889 - val_loss: 1.3988 - val_acc: 0.6575
Epoch 3/35
6660/6680 [============================>.] - ETA: 0s - loss: 0.7066 - acc: 0.7905Epoch 00002: val_loss improved from 1.39880 to 1.35278, saving model to saved_models/weights.best.VGG19.hdf5
6680/6680 [==============================] - 1s - loss: 0.7053 - acc: 0.7909 - val_loss: 1.3528 - val_acc: 0.6898
Epoch 4/35
6620/6680 [============================>.] - ETA: 0s - loss: 0.5183 - acc: 0.8485Epoch 00003: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.5202 - acc: 0.8481 - val_loss: 1.3754 - val_acc: 0.7186
Epoch 5/35
6540/6680 [============================>.] - ETA: 0s - loss: 0.3695 - acc: 0.8865Epoch 00004: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.3748 - acc: 0.8849 - val_loss: 1.3926 - val_acc: 0.7150
Epoch 6/35
6520/6680 [============================>.] - ETA: 0s - loss: 0.2777 - acc: 0.9095Epoch 00005: val_loss improved from 1.35278 to 1.34220, saving model to saved_models/weights.best.VGG19.hdf5
6680/6680 [==============================] - 1s - loss: 0.2804 - acc: 0.9091 - val_loss: 1.3422 - val_acc: 0.7377
Epoch 7/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.2208 - acc: 0.9318Epoch 00006: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.2203 - acc: 0.9319 - val_loss: 1.4130 - val_acc: 0.7353
Epoch 8/35
6620/6680 [============================>.] - ETA: 0s - loss: 0.1818 - acc: 0.9424Epoch 00007: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.1819 - acc: 0.9424 - val_loss: 1.4299 - val_acc: 0.7461
Epoch 9/35
6440/6680 [===========================>..] - ETA: 0s - loss: 0.1375 - acc: 0.9548Epoch 00008: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.1388 - acc: 0.9543 - val_loss: 1.6497 - val_acc: 0.7389
Epoch 10/35
6440/6680 [===========================>..] - ETA: 0s - loss: 0.1245 - acc: 0.9618Epoch 00009: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.1287 - acc: 0.9609 - val_loss: 1.6505 - val_acc: 0.7257
Epoch 11/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.1090 - acc: 0.9675Epoch 00010: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.1095 - acc: 0.9672 - val_loss: 1.6609 - val_acc: 0.7449
Epoch 12/35
6540/6680 [============================>.] - ETA: 0s - loss: 0.1028 - acc: 0.9711Epoch 00011: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.1034 - acc: 0.9710 - val_loss: 1.7257 - val_acc: 0.7365
Epoch 13/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0939 - acc: 0.9715    Epoch 00012: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0931 - acc: 0.9716 - val_loss: 1.7320 - val_acc: 0.7581
Epoch 14/35
6520/6680 [============================>.] - ETA: 0s - loss: 0.0919 - acc: 0.9744Epoch 00013: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0912 - acc: 0.9747 - val_loss: 1.8727 - val_acc: 0.7509
Epoch 15/35
6460/6680 [============================>.] - ETA: 0s - loss: 0.0759 - acc: 0.9776Epoch 00014: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0764 - acc: 0.9771 - val_loss: 1.9837 - val_acc: 0.7413
Epoch 16/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0722 - acc: 0.9808Epoch 00015: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0730 - acc: 0.9805 - val_loss: 1.9693 - val_acc: 0.7449
Epoch 17/35
6600/6680 [============================>.] - ETA: 0s - loss: 0.0765 - acc: 0.9800Epoch 00016: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0776 - acc: 0.9798 - val_loss: 1.9141 - val_acc: 0.7497
Epoch 18/35
6620/6680 [============================>.] - ETA: 0s - loss: 0.0654 - acc: 0.9801Epoch 00017: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0650 - acc: 0.9802 - val_loss: 1.9897 - val_acc: 0.7581
Epoch 19/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0822 - acc: 0.9802Epoch 00018: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0822 - acc: 0.9801 - val_loss: 2.0078 - val_acc: 0.7473
Epoch 20/35
6460/6680 [============================>.] - ETA: 0s - loss: 0.0753 - acc: 0.9824Epoch 00019: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0778 - acc: 0.9816 - val_loss: 1.9084 - val_acc: 0.7521
Epoch 21/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.0514 - acc: 0.9872    Epoch 00020: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0513 - acc: 0.9871 - val_loss: 2.0646 - val_acc: 0.7605
Epoch 22/35
6540/6680 [============================>.] - ETA: 0s - loss: 0.0647 - acc: 0.9838Epoch 00021: val_loss did not improve
6680/6680 [==============================] - 1s - loss: 0.0647 - acc: 0.9837 - val_loss: 2.0930 - val_acc: 0.7533
Epoch 23/35
6540/6680 [============================>.] - ETA: 0s - loss: 0.0612 - acc: 0.9843    Epoch 00022: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0666 - acc: 0.9837 - val_loss: 2.1955 - val_acc: 0.7449
Epoch 24/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0618 - acc: 0.9857Epoch 00023: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0615 - acc: 0.9858 - val_loss: 1.9099 - val_acc: 0.7653
Epoch 25/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.0610 - acc: 0.9863    Epoch 00024: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0607 - acc: 0.9864 - val_loss: 2.0630 - val_acc: 0.7796
Epoch 26/35
6620/6680 [============================>.] - ETA: 0s - loss: 0.0643 - acc: 0.9835    Epoch 00025: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0639 - acc: 0.9835 - val_loss: 2.2100 - val_acc: 0.7545
Epoch 27/35
6620/6680 [============================>.] - ETA: 0s - loss: 0.0560 - acc: 0.9876    Epoch 00026: val_loss did not improve
6680/6680 [==============================] - 3s - loss: 0.0564 - acc: 0.9873 - val_loss: 2.2730 - val_acc: 0.7509
Epoch 28/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0638 - acc: 0.9858 - ETA: 2s - loss: 0.0759 - acc: 0.9847Epoch 00027: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0635 - acc: 0.9859 - val_loss: 2.2569 - val_acc: 0.7593
Epoch 29/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.0586 - acc: 0.9861Epoch 00028: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0583 - acc: 0.9862 - val_loss: 2.3584 - val_acc: 0.7617
Epoch 30/35
6580/6680 [============================>.] - ETA: 0s - loss: 0.0549 - acc: 0.9892    Epoch 00029: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0542 - acc: 0.9892 - val_loss: 2.1245 - val_acc: 0.7653
Epoch 31/35
6640/6680 [============================>.] - ETA: 0s - loss: 0.0585 - acc: 0.9884    Epoch 00030: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0581 - acc: 0.9885 - val_loss: 2.0867 - val_acc: 0.7844
Epoch 32/35
6520/6680 [============================>.] - ETA: 0s - loss: 0.0547 - acc: 0.9868    Epoch 00031: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0546 - acc: 0.9868 - val_loss: 2.2097 - val_acc: 0.7701
Epoch 33/35
6540/6680 [============================>.] - ETA: 0s - loss: 0.0643 - acc: 0.9856Epoch 00032: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0629 - acc: 0.9859 - val_loss: 2.0449 - val_acc: 0.7796
Epoch 34/35
6580/6680 [============================>.] - ETA: 0s - loss: 0.0697 - acc: 0.9839    Epoch 00033: val_loss did not improve
6680/6680 [==============================] - 3s - loss: 0.0687 - acc: 0.9841 - val_loss: 2.4348 - val_acc: 0.7749
Epoch 35/35
6560/6680 [============================>.] - ETA: 0s - loss: 0.0502 - acc: 0.9899Epoch 00034: val_loss did not improve
6680/6680 [==============================] - 2s - loss: 0.0498 - acc: 0.9900 - val_loss: 2.2828 - val_acc: 0.7713

<keras.callbacks.History at 0x128d7f320>

(IMPLEMENTATION) Load the Model with the Best Validation Loss

### TODO: Load the model weights with the best validation loss.
VGG19_model.load_weights('saved_models/weights.best.VGG19.hdf5')

(IMPLEMENTATION) Test the Model

Try out your model on the test dataset of dog images. Ensure that your test accuracy is greater than 60%.

### TODO: Calculate classification accuracy on the test dataset.
VGG19_predictions = [np.argmax(VGG19_model.predict(np.expand_dims(feature, axis=0))) for feature in test_VGG19]

# report test accuracy
test_accuracy = 100*np.sum(np.array(VGG19_predictions)==np.argmax(test_targets, axis=1))/len(VGG19_predictions)
print('Test accuracy: %.4f%%' % test_accuracy)

Test accuracy: 71.7703%

(IMPLEMENTATION) Predict Dog Breed with the Model

Write a function that takes an image path as input and returns the dog breed (Affenpinscher, Afghan_hound, etc) that is predicted by your model.

Similar to the analogous function in Step 5, your function should have three steps:

    Extract the bottleneck features corresponding to the chosen CNN model.
    Supply the bottleneck features as input to the model to return the predicted vector. Note that the argmax of this prediction vector gives the index of the predicted dog breed.
    Use the dog_names array defined in Step 0 of this notebook to return the corresponding breed.

The functions to extract the bottleneck features can be found in extract_bottleneck_features.py, and they have been imported in an earlier code cell. To obtain the bottleneck features corresponding to your chosen CNN architecture, you need to use the function

extract_{network}

where {network}, in the above filename, should be one of VGG19, Resnet50, InceptionV3, or Xception.

### TODO: Write a function that takes a path to an image as input
### and returns the dog breed that is predicted by the model.

def predict_dog_breed(image_path):  # this function predicts the breed of dog 
   feature = extract_VGG19(path_to_tensor(image_path))
   predicted_vector = VGG16_model.predict(feature) # getting the predicted vector using the model
   return dog_names[np.argmax(predicted_vector)] # getting the dog name from the output vector

Step 6: Write your Algorithm

Write an algorithm that accepts a file path to an image and first determines whether the image contains a human, dog, or neither. Then,

    if a dog is detected in the image, return the predicted breed.
    if a human is detected in the image, return the resembling dog breed.
    if neither is detected in the image, provide output that indicates an error.

You are welcome to write your own functions for detecting humans and dogs in images, but feel free to use the face_detector and human_detector functions developed above. You are required to use your CNN from Step 5 to predict dog breed.

Some sample output for our algorithm is provided below, but feel free to design your own user experience!

Sample Human Output
(IMPLEMENTATION) Write your Algorithm

### TODO: Write your algorithm.
### Feel free to use as many code cells as needed.
from IPython.core.display import Image, display

def my_breed_detector(image_path):  # this function checks if the image contains dog or human and detects dog breed
    display(Image(image_path,width=200,height=200))
    if dog_detector(image_path):    # checking if it's a dog image
       print("It's an image containing dog") 
       return predict_dog_breed(image_path)
    elif face_detector(image_path): # checking if it's a human image
       print("It's an image containing a human") 
       return predict_dog_breed(image_path)
    else:
       return "Error"               # if there is no dog or human, "Error" is returned

Step 7: Test Your Algorithm

In this section, you will take your new algorithm for a spin! What kind of dog does the algorithm think that you look like? If you have a dog, does it predict your dog's breed accurately? If you have a cat, does it mistakenly think that your cat is a dog?
(IMPLEMENTATION) Test Your Algorithm on Sample Images!

Test your algorithm at least six images on your computer. Feel free to use any images you like. Use at least two human and two dog images.

Question 6: Is the output better than you expected :) ? Or worse :( ? Provide at least three possible points of improvement for your algorithm.

Answer: The model is good enough considering the training time, it has accuracy of 71%. It classifies the two dog breeds tested here, accurately. Also, if there is no dog present(e.g. image of cat), it gives error.

Traning time could be improved further. Accuracy is 71%, so almost 30% classifications are wrong, for a dog breed detector used in real life applications, it should be close to 100%. Other thing can be improved is, detecting multiple dogs' breeds (if present in a picture).

## TODO: Execute your algorithm from Step 6 on
## at least 6 images on your computer.
## Feel free to use as many code cells as needed.
my_file = np.array(glob("my_images/australian_cattle_dog.jpg"))
print(my_breed_detector(my_file[0]))

It's an image containing dog
Australian_cattle_dog

my_file = np.array(glob("my_images/labrador.jpg"))
print(my_breed_detector(my_file[0]))

It's an image containing dog
Labrador_retriever

my_file = np.array(glob("my_images/kathy.jpg"))
print(my_breed_detector(my_file[0]))

It's an image containing a human
Komondor

my_file = np.array(glob("my_images/aish.jpg"))
print(my_breed_detector(my_file[0]))

It's an image containing a human
Greyhound

my_file = np.array(glob("my_images/other_1.jpg"))
print(my_breed_detector(my_file[0]))

Error

my_file = np.array(glob("my_images/cat.jpg"))
print(my_breed_detector(my_file[0]))

Error

